
import os
import sys
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# Add src to python path to allow imports
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from src.middleware.memory import Base, ConversationSession, ConversationMessage

def init_db():
    print("Initializing database...")
    
    # Get database URL from env
    db_url = os.getenv(
        "DATABASE_URL",
        "postgresql://postgres:postgres@localhost:5432/coding_agent"
    )
    
    print(f"Connecting to: {db_url}")
    
    try:
        engine = create_engine(db_url)
        
        # Create all tables defined in Base
        print("Creating tables...")
        Base.metadata.create_all(engine)
        
        print("✅ Database initialized successfully!")
        
        # Verify tables created
        from sqlalchemy import inspect
        inspector = inspect(engine)
        tables = inspector.get_table_names()
        print(f"Tables present: {tables}")
        
    except Exception as e:
        print(f"❌ Error initializing database: {e}")
        sys.exit(1)

if __name__ == "__main__":
    from dotenv import load_dotenv
    load_dotenv()
    init_db()
